openapi: 3.0.3
info:
  title: Kakao Pay Payment Refund API
  description: |
    Refunds/cancels a completed payment (full or partial).

    **Usage**:
    - Admin-initiated refunds (customer service)
    - Full refunds (cancel entire order)
    - Partial refunds (cancel some items)

    **Security**: Requires valid JWT access token with admin privileges

    **Note**: MVP frontend does not expose refund UI. This endpoint is called via backend admin tools or API.
  version: 1.0.0

servers:
  - url: http://localhost:8080
    description: Development server
  - url: https://api.udonggeum.com
    description: Production server

paths:
  /api/v1/payments/kakao/{orderID}/refund:
    post:
      summary: Refund payment for order
      description: |
        Refunds a completed payment by calling Kakao Pay /cancel API.

        **Authorization**: Requires admin role

        **Idempotency**: Multiple calls with same amount return existing refund data

        **Partial Refunds**:
        - If cancel_amount < total_amount, payment_status remains 'completed'
        - If cancel_amount = total_amount, payment_status changes to 'refunded'
      operationId: refundPayment
      tags:
        - Payments
      security:
        - bearerAuth: []
      parameters:
        - name: orderID
          in: path
          required: true
          description: Order ID to refund payment for
          schema:
            type: integer
            format: int32
            minimum: 1
            example: 123

      requestBody:
        required: true
        description: Refund amount (can be partial or full)
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentRefundRequest'
            examples:
              full_refund:
                summary: Full refund
                value:
                  cancel_amount: 50000
              partial_refund:
                summary: Partial refund (10,000 of 50,000)
                value:
                  cancel_amount: 10000

      responses:
        '200':
          description: Payment refunded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentRefundResponse'
              examples:
                full_refund:
                  summary: Full refund completed
                  value:
                    message: Payment cancelled successfully
                    data:
                      order_id: 123
                      tid: T91ca901315e2b03efcd
                      canceled_amount: 50000
                      remaining_amount: 0
                      canceled_at: '2025-01-19T15:00:00Z'
                partial_refund:
                  summary: Partial refund completed
                  value:
                    message: Payment partially refunded
                    data:
                      order_id: 123
                      tid: T91ca901315e2b03efcd
                      canceled_amount: 10000
                      remaining_amount: 40000
                      canceled_at: '2025-01-19T15:00:00Z'

        '400':
          description: Bad request (invalid amount or exceeds remaining amount)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid_amount:
                  summary: Amount is zero or negative
                  value:
                    error: Refund amount must be greater than 0
                exceeds_remaining:
                  summary: Refund exceeds remaining amount
                  value:
                    error: Refund amount exceeds remaining amount

        '401':
          description: Unauthorized (missing or invalid JWT token)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missing_token:
                  summary: No authorization header
                  value:
                    error: Authorization header is required

        '403':
          description: Forbidden (user is not admin)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_admin:
                  summary: User lacks admin privileges
                  value:
                    error: Admin privileges required

        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                order_not_found:
                  summary: Order does not exist
                  value:
                    error: Order not found

        '409':
          description: Conflict (payment not completed or already refunded)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_completed:
                  summary: Cannot refund pending payment
                  value:
                    error: Payment is not completed
                already_refunded:
                  summary: Payment already fully refunded
                  value:
                    error: Payment has already been fully refunded

        '500':
          description: Internal server error (Kakao Pay API error or database error)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                kakaopay_error:
                  summary: Kakao Pay /cancel API error
                  value:
                    error: Failed to refund payment with Kakao Pay
                database_error:
                  summary: Database update error
                  value:
                    error: Failed to update order refund status

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token with admin role

  schemas:
    PaymentRefundRequest:
      type: object
      required:
        - cancel_amount
      properties:
        cancel_amount:
          type: integer
          format: int32
          minimum: 1
          description: Amount to refund in KRW (can be partial or full)
          example: 50000
      additionalProperties: false

    PaymentRefundResponse:
      type: object
      required:
        - message
        - data
      properties:
        message:
          type: string
          description: Success message
          example: Payment cancelled successfully
        data:
          $ref: '#/components/schemas/PaymentRefundData'

    PaymentRefundData:
      type: object
      required:
        - order_id
        - tid
        - canceled_amount
        - remaining_amount
        - canceled_at
      properties:
        order_id:
          type: integer
          format: int32
          minimum: 1
          description: Order ID that was refunded
          example: 123
        tid:
          type: string
          minLength: 1
          description: Original transaction ID
          example: T91ca901315e2b03efcd
        canceled_amount:
          type: integer
          format: int32
          minimum: 0
          description: Amount refunded in this request
          example: 50000
        remaining_amount:
          type: integer
          format: int32
          minimum: 0
          description: Remaining amount not refunded (0 for full refund)
          example: 0
        canceled_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp when refund was processed
          example: '2025-01-19T15:00:00Z'

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: string
          description: Human-readable error message in Korean
          example: 환불 금액이 잘못되었습니다

tags:
  - name: Payments
    description: Payment operations via Kakao Pay
