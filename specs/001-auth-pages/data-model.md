# Data Model: Authentication

## Entities

### User
- **Source**: `src/schemas/auth.ts` (UserSchema)
- **Fields**:
  - `id`: number (unique, auto-generated by backend)
  - `email`: string (unique, validated with email regex)
  - `name`: string (required, min 1 char)
  - `phone`: string | undefined (optional, Korean format: `01[0-9]-?[0-9]{3,4}-?[0-9]{4}`)
  - `role`: "user" | "admin" (enum, determines access level)
  - `created_at`: string (ISO 8601 datetime, set by backend)
  - `updated_at`: string (ISO 8601 datetime, updated by backend)
- **Validation Rules**:
  - Email must be valid format (`z.string().email()`)
  - Name must not be empty (`z.string().min(1)`)
  - Phone must match Korean mobile pattern if provided
- **Relationships**: None in MVP (future: orders, favorites)

### Tokens
- **Source**: `src/schemas/auth.ts` (TokensSchema)
- **Fields**:
  - `access_token`: string (JWT, short-lived: 15-30 min)
  - `refresh_token`: string (JWT, long-lived: 7 days)
- **Validation Rules**:
  - Both tokens must be non-empty strings (`z.string().min(1)`)
- **Storage**: localStorage via Zustand persist middleware
- **Lifecycle**:
  - Created on login/register
  - Access token refreshed automatically on expiration (via Axios interceptor)
  - Both cleared on logout or refresh failure

### AuthState (Client-Side)
- **Source**: `src/stores/useAuthStore.ts`
- **Fields**:
  - `user`: User | null (current authenticated user)
  - `tokens`: Tokens | null (authentication credentials)
  - `isAuthenticated`: boolean (computed from tokens presence)
- **Persistence**: Stored in localStorage
- **Actions**:
  - `setAuth(user, tokens)`: Set user and tokens after login/register
  - `clearAuth()`: Clear user and tokens on logout/401
  - `updateTokens(tokens)`: Update tokens after refresh

## State Transitions

### Authentication Flow

#### Login
1. **Initial**: User on any page, not authenticated
2. **Trigger**: User navigates to `/login` or clicks "로그인"
3. **Action**: User submits email + password
4. **Validation**: Zod validates input (email format, password min 6 chars)
5. **API Call**: `POST /api/auth/login` with credentials
6. **Success**:
   - Store tokens and user in `useAuthStore`
   - Redirect to intended page or homepage
7. **Failure**: Display error message, remain on login page

#### Register
1. **Initial**: User on any page, not authenticated
2. **Trigger**: User clicks "회원가입" on login page
3. **Action**: User submits email + password + name + phone (optional)
4. **Validation**: Zod validates all fields
5. **API Call**: `POST /api/auth/register` with user data
6. **Success**:
   - Auto-login (store tokens and user)
   - Redirect to homepage
7. **Failure**: Display error message (e.g., "이미 사용 중인 이메일입니다")

#### Token Refresh
1. **Trigger**: Access token expired, user makes authenticated request
2. **Detection**: Axios interceptor catches 401 response
3. **Action**: Send refresh token to `POST /api/auth/refresh`
4. **Success**:
   - Update `access_token` in `useAuthStore`
   - Retry original request
5. **Failure**:
   - Clear auth state
   - Redirect to login with message "세션이 만료되었습니다"

#### Logout
1. **Trigger**: User clicks "로그아웃" on My Page
2. **Action**: Call `POST /api/auth/logout` (optional backend cleanup)
3. **Cleanup**: Clear tokens and user from `useAuthStore` and localStorage
4. **Redirect**: Navigate to homepage

## Validation Examples

### Registration Input
```typescript
const data = {
  email: "user@example.com",
  password: "password123",
  name: "홍길동",
  phone: "010-1234-5678",
};

const validated = RegisterRequestSchema.parse(data);
// Success: validated data passed to API
```

### Error Handling
```typescript
try {
  RegisterRequestSchema.parse({ email: "invalid" });
} catch (error) {
  if (error instanceof ZodError) {
    // Extract Korean error messages
    const errors = error.errors.map(e => e.message);
    // ["유효한 이메일을 입력하세요"]
  }
}
```
